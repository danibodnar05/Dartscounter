<!DOCTYPE html>
<html lang="hu" class="overscroll-none">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Darts Pro">
    <meta name="theme-color" content="#0f172a">
    
    <title>Darts Sz√°ml√°l√≥ Pro</title>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- MOBILE DESIGN SYSTEM --- */
        :root {
            /* Fallback √©rt√©kek, ha a b√∂ng√©sz≈ë nem t√°mogatja az env-t */
            --sat: env(safe-area-inset-top, 20px);
            --sab: env(safe-area-inset-bottom, 20px);
            --sal: env(safe-area-inset-left, 0px);
            --sar: env(safe-area-inset-right, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: radial-gradient(circle at top, #1e1b4b, #0f172a, #000000);
            touch-action: manipulation;
            /* Modern magass√°g kezel√©s mobilra */
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport Height */
        }

        /* --- BIZTONS√ÅGOS Z√ìNA OSZT√ÅLY --- */
        /* Ez biztos√≠tja, hogy a tartalom ne l√≥gjon a notch-ba vagy a home cs√≠k al√° */
        .safe-area-container {
            padding-top: var(--sat);
            padding-bottom: var(--sab);
            padding-left: var(--sal);
            padding-right: var(--sar);
        }
        
        h1, .score-display, .font-digit, .keypad-btn, .modifier-btn {
            font-family: 'Orbitron', sans-serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .active-player {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(15, 23, 42, 0.8));
            border: 1px solid #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
            z-index: 10;
        }

        .inactive-player {
            opacity: 0.6;
            transform: scale(0.98);
        }

        .keypad-btn {
            background: linear-gradient(to bottom, #334155, #1e293b);
            border-bottom: 2px solid #0f172a;
            border-top: 1px solid #475569;
            transition: transform 0.05s;
        }
        .keypad-btn:active {
            transform: scale(0.95);
            background: #1e293b;
        }

        .modifier-btn {
            background: linear-gradient(to bottom, #334155, #1e293b);
            border: 1px solid #475569;
        }
        .modifier-btn.active {
            background: linear-gradient(to bottom, #fbbf24, #d97706);
            color: black;
            border-color: #f59e0b;
        }
        .modifier-btn.active-red {
            background: linear-gradient(to bottom, #f87171, #dc2626);
            color: white;
            border-color: #ef4444;
        }

        /* Darts t√°bla st√≠lusok */
        #dartboard-svg {
            width: 100%;
            height: 100%;
            max-height: 40vh;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
            touch-action: none;
        }
        .board-segment { stroke: #d4d4d4; stroke-width: 1px; }
        .c-black { fill: #0f172a; }
        .c-white { fill: #cbd5e1; }
        .c-red { fill: #ef4444; }
        .c-green { fill: #22c55e; }
        .board-text { font-family: 'Orbitron', sans-serif; font-size: 16px; fill: #fff; text-anchor: middle; dominant-baseline: middle; pointer-events: none; }

        .input-toggle-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            transition: all 0.3s;
        }
        .input-toggle-btn.active {
            background: #22c55e;
            color: white;
            border-color: #22c55e;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        .num-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.25rem;
        }
        
        input[type="text"], select {
            font-size: 16px !important;
        }
        
        #pwa-install-prompt {
            display: none;
        }
    </style>
</head>
<body class="text-white flex flex-col w-full max-w-lg mx-auto bg-black safe-area-container">

    <div id="setup-screen" class="flex flex-col h-full w-full p-4 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full -z-10 opacity-30 pointer-events-none bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-900 via-gray-900 to-black"></div>

        <div class="flex-shrink-0 text-center mb-4 mt-2">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600 tracking-wider">
                DARTS PRO
            </h1>
        </div>
        
        <div class="flex-1 glass-panel p-4 rounded-xl flex flex-col overflow-hidden border border-white/10 w-full mb-2">
            
            <div class="flex justify-between items-center mb-3 flex-shrink-0">
                <label class="text-gray-300 text-xs font-bold uppercase tracking-wider">J√°t√©kosok</label>
                <div class="flex gap-2">
                    <button onclick="shufflePlayers()" class="text-blue-400 bg-blue-500/10 px-3 py-2 rounded text-xs font-bold flex items-center gap-1 active:scale-95 transition">
                        üîÄ Kever√©s
                    </button>
                    <button onclick="addPlayerInput()" class="text-green-400 bg-green-500/10 px-3 py-2 rounded text-xs font-bold flex items-center gap-1 active:scale-95 transition">
                        + Hozz√°ad√°s
                    </button>
                </div>
            </div>
            
            <div id="setup-player-list" class="space-y-2 overflow-y-auto flex-1 mb-4 pr-1">
            </div>

            <div class="space-y-3 pt-3 border-t border-gray-700/50 flex-shrink-0">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-400 mb-1 text-[10px] font-bold uppercase">Pontsz√°m</label>
                        <select id="start-score-select" class="w-full p-2 bg-slate-800 rounded border border-gray-600 text-white font-bold">
                            <option value="301">301</option>
                            <option value="501" selected>501</option>
                            <option value="701">701</option>
                        </select>
                    </div>
                    <div class="flex flex-col justify-end">
                    </div>
                </div>

                <div class="bg-slate-800/40 p-2 rounded-lg space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300 text-sm">Double In</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="double-in-check" class="sr-only peer">
                            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300 text-sm">Double Out</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="double-out-check" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                </div>
                
                <button onclick="startGame()" class="w-full bg-gradient-to-r from-green-600 to-green-500 text-white font-bold py-3 rounded-lg text-lg shadow-lg active:scale-[0.98] transition-transform uppercase tracking-widest mt-2">
                    START
                </button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden flex-col h-full w-full relative bg-slate-900">
        
        <div class="px-3 py-2 flex justify-between items-center glass-panel z-50 flex-shrink-0 h-14">
            <button onclick="resetSetup()" class="text-gray-400 p-2 rounded-full hover:bg-white/10 active:scale-90 transition">
                <span class="text-xl font-bold">‚ùÆ</span>
            </button>
            
            <div class="flex gap-2 text-[10px] font-mono font-bold">
                <span id="rule-indicator-in" class="hidden px-2 py-1 border border-green-500/50 text-green-400 bg-green-500/10 rounded">DI</span>
                <span id="rule-indicator-out" class="hidden px-2 py-1 border border-red-500/50 text-red-400 bg-red-500/10 rounded">DO</span>
            </div>
            
            <button onclick="restartGame()" class="text-green-400 p-2 rounded-full hover:bg-white/10 active:scale-90 transition">
                <span class="text-xl font-bold">‚Ü∫</span>
            </button>
        </div>

        <div id="players-container" class="flex-1 grid grid-cols-2 gap-2 p-2 overflow-y-auto content-start">
        </div>

        <div class="bg-black/80 backdrop-blur py-2 px-4 border-t border-white/10 flex justify-between items-center h-16 flex-shrink-0 z-20">
            <div class="flex gap-2 items-center">
                <div id="dart-1" class="w-10 h-10 bg-gray-800 rounded border border-gray-600 flex items-center justify-center text-sm font-digit text-gray-400"></div>
                <div id="dart-2" class="w-10 h-10 bg-gray-800 rounded border border-gray-600 flex items-center justify-center text-sm font-digit text-gray-400"></div>
                <div id="dart-3" class="w-10 h-10 bg-gray-800 rounded border border-gray-600 flex items-center justify-center text-sm font-digit text-gray-400"></div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-gray-500 uppercase">Turn</div>
                <div class="text-green-400 text-2xl font-digit font-bold leading-none" id="turn-total">0</div>
            </div>
        </div>

        <div class="bg-slate-900 border-t border-gray-800 p-2 flex-shrink-0 z-30">
            
            <div class="flex justify-center mb-2">
                <div class="bg-gray-800 p-1 rounded-lg flex w-full max-w-xs">
                    <button onclick="switchInputMode('keypad')" id="toggle-keypad" class="input-toggle-btn active flex-1 py-1 text-xs font-bold uppercase rounded-md">123</button>
                    <button onclick="switchInputMode('board')" id="toggle-board" class="input-toggle-btn flex-1 py-1 text-xs font-bold uppercase rounded-md">üéØ</button>
                </div>
            </div>

            <div id="keypad-mode-container" class="flex flex-col gap-2">
                <div class="flex gap-2 h-10">
                    <button onclick="toggleModifier('double')" id="btn-double" class="modifier-btn flex-1 rounded text-red-400 font-bold text-sm active:scale-95">DOUBLE</button>
                    <button onclick="toggleModifier('triple')" id="btn-triple" class="modifier-btn flex-1 rounded text-yellow-400 font-bold text-sm active:scale-95">TRIPLE</button>
                    <button onclick="undoThrow()" class="w-14 bg-slate-700 rounded text-white text-lg flex items-center justify-center active:scale-95 shadow">‚å´</button>
                </div>

                <div class="num-grid h-36">
                    <script>
                        for(let i=1; i<=20; i++) {
                            document.write(`<button onclick="handleThrow(${i})" class="keypad-btn rounded text-lg font-bold text-gray-200 active:bg-slate-700">${i}</button>`);
                        }
                    </script>
                </div>
                  
                <div class="flex gap-2 h-12">
                    <button onclick="handleThrow(25)" class="flex-1 bg-red-900/40 text-red-200 border border-red-900 rounded font-bold text-sm active:bg-red-900">BULL</button>
                    <button onclick="handleThrow(0)" class="flex-1 bg-gray-700 text-gray-300 rounded font-bold text-sm active:bg-gray-600">MISS</button>
                    <button onclick="confirmTurn()" id="btn-next-keypad" class="flex-[2] bg-green-600 text-white rounded font-bold text-xl active:bg-green-700 shadow-lg">
                        NEXT
                    </button>
                </div>
            </div>

            <div id="board-mode-container" class="hidden flex flex-col h-full">
                <div id="dartboard-wrapper" class="w-full flex justify-center items-center flex-1 min-h-0 mb-2">
                </div>
                <div class="flex gap-2 h-12">
                    <button onclick="undoThrow()" class="w-14 bg-slate-700 rounded text-white text-lg flex items-center justify-center active:scale-95">‚å´</button>
                     <button onclick="handleThrow(0)" class="w-16 bg-gray-700 text-gray-300 rounded font-bold text-xs active:bg-gray-600">MISS</button>
                    <button onclick="confirmTurn()" id="btn-next-board" class="flex-1 bg-green-600 text-white rounded font-bold text-xl active:bg-green-700 shadow-lg">
                        NEXT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="winner-modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-sm flex items-center justify-center z-[100] px-4">
        <div class="bg-slate-900 p-6 rounded-2xl text-center w-full max-w-sm border border-green-500/30 shadow-2xl">
            <div class="text-6xl mb-4 animate-bounce">üèÜ</div>
            <h2 class="text-3xl font-bold text-white mb-2 font-digit">VICTORY</h2>
            <p id="winner-name" class="text-2xl text-green-400 font-bold mb-6 font-digit">J√°t√©kos 1</p>
            <button onclick="closeWinnerModal()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg text-lg active:scale-95 transition">
                √öj Meccs
            </button>
        </div>
    </div>

    <script>
        // --- J√ÅT√âK √ÅLLAPOT ---
        let gameState = {
            players: [],
            currentPlayerIndex: 0,
            startScore: 501,
            doubleIn: false,
            doubleOut: true,
            turnDarts: [], 
            multiplier: 1,
            inputMode: 'keypad'
        };

        const checkouts = { 170:"T20 T20 BULL",167:"T20 T19 BULL",164:"T20 T18 BULL",161:"T20 T17 BULL",160:"T20 T20 D20",158:"T20 T20 D19",157:"T20 T19 D20",156:"T20 T20 D18",155:"T20 T19 D19",154:"T20 T18 D20",153:"T20 T19 D18",152:"T20 T20 D16",151:"T20 T17 D20",150:"T20 T18 D18",149:"T20 T19 D16",148:"T20 T16 D20",147:"T20 T17 D18",146:"T20 T18 D16",145:"T20 T15 D20",144:"T20 T20 D12",143:"T20 T17 D16",142:"T20 T14 D20",141:"T20 T19 D12",140:"T20 T16 D16",139:"T20 T13 D20",138:"T20 T18 D12",137:"T19 T16 D16",136:"T20 T20 D8",135:"T20 T15 D15",134:"T20 T14 D16",133:"T20 T19 D8",132:"T20 T16 D12",131:"T20 T13 D16",130:"T20 T18 D8",129:"T19 T16 D12",128:"T18 T14 D16",127:"T20 T17 D8",126:"T19 T19 D6",125:"BULL T17 D12",124:"T20 T16 D8",123:"T19 T16 D9",122:"T18 T20 D4",121:"T20 T15 D8",120:"T20 20 D20",119:"T19 T10 D16",118:"T20 18 D20",117:"T20 17 D20",116:"T20 16 D20",115:"T20 15 D20",114:"T20 14 D20",113:"T20 13 D20",112:"T20 12 D20",111:"T20 19 D16",110:"T20 18 D16",109:"T20 17 D16",108:"T20 16 D16",107:"T19 18 D16",106:"T20 14 D16",105:"T20 13 D16",104:"T18 18 D16",103:"T20 3 D20",102:"T20 10 D16",101:"T17 10 D20",100:"T20 D20",99:"T19 10 D16",98:"T20 D19",97:"T19 D20",96:"T20 D18",95:"T19 D19",94:"T18 D20",93:"T19 D18",92:"T20 D16",91:"T17 D20",90:"T18 D18",89:"T19 D16",88:"T16 D20",87:"T17 D18",86:"T18 D16",85:"T15 D20",84:"T20 D12",83:"T17 D16",82:"BULL D16",81:"T19 D12",80:"T20 D10",79:"T13 D20",78:"T18 D12",77:"T19 D10",76:"T20 D8",75:"T17 D12",74:"T14 D16",73:"T19 D8",72:"T16 D12",71:"T13 D16",70:"T18 D8",69:"T19 D6",68:"T20 D4",67:"T17 D8",66:"T10 D18",65:"T19 D4",64:"T16 D8",63:"T13 D12",62:"T10 D16",61:"T15 D8",60:"20 D20",59:"19 D20",58:"18 D20",57:"17 D20",56:"16 D20",55:"15 D20",54:"14 D20",53:"13 D20",52:"12 D20",51:"19 D16",50:"18 D16",49:"17 D16",48:"16 D16",47:"15 D16",46:"14 D16",45:"13 D16",44:"12 D16",43:"11 D16",42:"10 D16",41:"9 D16",40:"D20",39:"7 D16",38:"D19",37:"5 D16",36:"D18",35:"3 D16",34:"D17",33:"1 D16",32:"D16",31:"15 D8",30:"D15",29:"13 D8",28:"D14",27:"11 D8",26:"D13",25:"9 D8",24:"D12",23:"7 D8",22:"D11",21:"5 D8",20:"D10",19:"3 D8",18:"D9",17:"1 D8",16:"D8",15:"7 D4",14:"D7",13:"5 D4",12:"D6",11:"3 D4",10:"D5",9:"1 D4",8:"D4",7:"3 D2",6:"D3",5:"1 D2",4:"D2",3:"1 D1",2:"D1" };

        function getCheckout(score) {
            if (score > 170 || score < 2) return null;
            return checkouts[score] || null;
        }

        // --- SETUP ---
        let setupPlayerCount = 0;
        function initSetup() {
            const container = document.getElementById('setup-player-list');
            container.innerHTML = '';
            setupPlayerCount = 0;
            addPlayerInput("J√°t√©kos 1");
            addPlayerInput("J√°t√©kos 2");
        }

        function addPlayerInput(defaultName = "") {
            setupPlayerCount++;
            const name = defaultName || `J√°t√©kos ${setupPlayerCount}`;
            const container = document.getElementById('setup-player-list');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center animate-fade-in";
            div.innerHTML = `
                <input type="text" class="player-name-input flex-1 p-3 bg-slate-800 rounded border border-gray-600 text-white" value="${name}" placeholder="N√©v">
                ${setupPlayerCount > 2 ? `<button onclick="removePlayerInput(this)" class="w-10 h-full text-red-400 font-bold p-2 text-xl">√ó</button>` : ''}
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removePlayerInput(btn) { btn.parentElement.remove(); setupPlayerCount--; }

        function shufflePlayers() {
            const container = document.getElementById('setup-player-list');
            const inputs = Array.from(container.querySelectorAll('.player-name-input'));
            const values = inputs.map(input => input.value);
            for (let i = values.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [values[i], values[j]] = [values[j], values[i]];
            }
            inputs.forEach((input, index) => {
                input.value = values[index];
                input.parentElement.classList.add('brightness-150');
                setTimeout(() => input.parentElement.classList.remove('brightness-150'), 300);
            });
        }

        // --- T√ÅBLA GENER√ÅL√ÅS ---
        function generateDartboard() {
            const wrapper = document.getElementById('dartboard-wrapper');
            if(wrapper.children.length > 0) return;
            const order = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("id", "dartboard-svg");
            svg.setAttribute("viewBox", "-210 -210 420 420");
            
            const r_bull = 12, r_outer_bull = 30, r_inner_single = 95, r_triple = 105, r_outer_single = 160, r_double = 170;
            
            function createCircle(r, cls, onClick) {
                const c = document.createElementNS(svgNS, "circle");
                c.setAttribute("r", r);
                c.setAttribute("class", cls + " board-segment");
                if (onClick) c.onclick = onClick;
                return c;
            }
            function createSlicePath(start, end, inR, outR, cls, val, mult) {
                const s = (start - 90) * Math.PI / 180;
                const e = (end - 90) * Math.PI / 180;
                const pathData = `M ${outR * Math.cos(s)} ${outR * Math.sin(s)} A ${outR} ${outR} 0 0 1 ${outR * Math.cos(e)} ${outR * Math.sin(e)} L ${inR * Math.cos(e)} ${inR * Math.sin(e)} A ${inR} ${inR} 0 0 0 ${inR * Math.cos(s)} ${inR * Math.sin(s)} Z`;
                const path = document.createElementNS(svgNS, "path");
                path.setAttribute("d", pathData);
                path.setAttribute("class", cls + " board-segment");
                path.onclick = () => handleThrow(val, mult);
                return path;
            }
            function createText(angle, dist, text) {
                const rad = (angle - 90) * Math.PI / 180;
                const t = document.createElementNS(svgNS, "text");
                t.setAttribute("x", dist * Math.cos(rad));
                t.setAttribute("y", dist * Math.sin(rad) + 5);
                t.setAttribute("class", "board-text");
                t.textContent = text;
                return t;
            }
            const gSlices = document.createElementNS(svgNS, "g");
            const angleStep = 360 / 20;
            order.forEach((val, i) => {
                const cAng = i * angleStep, sAng = cAng - angleStep/2, eAng = cAng + angleStep/2;
                const isEven = i % 2 === 0;
                const cSingle = isEven ? "c-black" : "c-white";
                const cSpecial = isEven ? "c-red" : "c-green";
                gSlices.appendChild(createSlicePath(sAng, eAng, r_outer_single, r_double, cSpecial, val, 2));
                gSlices.appendChild(createSlicePath(sAng, eAng, r_triple, r_outer_single, cSingle, val, 1));
                gSlices.appendChild(createSlicePath(sAng, eAng, r_inner_single, r_triple, cSpecial, val, 3));
                gSlices.appendChild(createSlicePath(sAng, eAng, r_outer_bull, r_inner_single, cSingle, val, 1));
                svg.appendChild(createText(cAng, r_double + 25, val.toString()));
            });
            svg.appendChild(gSlices);
            svg.appendChild(createCircle(r_outer_bull, "c-green", () => handleThrow(25, 1)));
            svg.appendChild(createCircle(r_bull, "c-red", () => handleThrow(25, 2)));
            wrapper.appendChild(svg);
        }

        // --- START GAME ---
        function startGame() {
            const inputs = document.querySelectorAll('.player-name-input');
            const newPlayers = [];
            inputs.forEach((input, index) => {
                newPlayers.push({
                    id: index,
                    name: input.value.trim() || `J√°t√©kos ${index + 1}`,
                    score: parseInt(document.getElementById('start-score-select').value),
                    legs: 0, totalScore: 0, totalDarts: 0
                });
            });
            if (newPlayers.length < 1) return;

            gameState.players = newPlayers;
            gameState.startScore = gameState.players[0].score;
            gameState.currentPlayerIndex = 0;
            gameState.doubleIn = document.getElementById('double-in-check').checked;
            gameState.doubleOut = document.getElementById('double-out-check').checked;
            gameState.inputMode = 'keypad';

            const di = document.getElementById('rule-indicator-in');
            const dOut = document.getElementById('rule-indicator-out');
            gameState.doubleIn ? di.classList.remove('hidden') : di.classList.add('hidden');
            gameState.doubleOut ? dOut.classList.remove('hidden') : dOut.classList.add('hidden');

            startNewTurn();
            renderGamePlayers();
            updateUI();
            generateDartboard();
            switchInputMode('keypad');

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('flex');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
        }

        function renderGamePlayers() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            gameState.players.forEach((player, index) => {
                const card = document.createElement('div');
                card.id = `player-card-${index}`;
                // Kisebb, kompaktabb k√°rty√°k mobilon
                card.className = `glass-panel rounded-xl p-2 flex flex-col items-center justify-center relative transition-all duration-300 min-h-[110px] inactive-player`;
                card.innerHTML = `
                    <div class="text-gray-300 text-xs font-bold uppercase tracking-wider mb-1 truncate w-full text-center">${player.name}</div>
                    <div class="text-4xl sm:text-5xl font-bold text-white tracking-tighter score-display neon-text">${player.score}</div>
                    <div id="checkout-container-${index}" class="min-h-[20px] w-full text-center"></div>
                    <div class="mt-auto w-full flex justify-between items-center text-[10px] text-gray-400 bg-slate-900/50 px-2 py-1 rounded border border-white/5">
                        <span>Legs: <span id="legs-${index}" class="text-white">0</span></span>
                        <span>Avg: <span id="avg-${index}" class="text-white">0.0</span></span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function restartGame() {
            gameState.players.forEach(p => {
                p.score = gameState.startScore;
                p.totalScore = 0; p.totalDarts = 0;
            });
            gameState.currentPlayerIndex = 0;
            startNewTurn();
            updateUI();
        }

        function startNewTurn() {
            gameState.turnDarts = [];
            gameState.multiplier = 1;
            resetModifiers();
            updateTurnDisplay();
        }

        function resetSetup() {
            if(confirm("Biztos kil√©psz?")) {
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('flex');
                document.getElementById('setup-screen').classList.remove('hidden');
                document.getElementById('setup-screen').classList.add('flex');
            }
        }

        function switchInputMode(mode) {
            gameState.inputMode = mode;
            const kBtn = document.getElementById('toggle-keypad');
            const bBtn = document.getElementById('toggle-board');
            const kCon = document.getElementById('keypad-mode-container');
            const bCon = document.getElementById('board-mode-container');
            
            if (mode === 'keypad') {
                kBtn.classList.add('active'); bBtn.classList.remove('active');
                kCon.classList.remove('hidden'); bCon.classList.add('hidden');
            } else {
                kBtn.classList.remove('active'); bBtn.classList.add('active');
                kCon.classList.add('hidden'); bCon.classList.remove('hidden');
                resetModifiers();
            }
        }

        function updateUI() {
            gameState.players.forEach((player, index) => {
                const card = document.getElementById(`player-card-${index}`);
                const scoreDiv = card.querySelector('.score-display');
                const legsSpan = document.getElementById(`legs-${index}`);
                const avgSpan = document.getElementById(`avg-${index}`);
                const checkoutContainer = document.getElementById(`checkout-container-${index}`);

                scoreDiv.innerText = player.score;
                legsSpan.innerText = player.legs;
                const avg = player.totalDarts > 0 ? ((player.totalScore / player.totalDarts) * 3).toFixed(1) : "0.0";
                avgSpan.innerText = avg;

                checkoutContainer.innerHTML = '';
                if (index === gameState.currentPlayerIndex && gameState.doubleOut) {
                    const checkout = getCheckout(player.score);
                    if (checkout) checkoutContainer.innerHTML = `<span class="text-yellow-400 text-xs font-bold bg-yellow-400/10 px-2 py-0.5 rounded-full border border-yellow-400/30 animate-pulse block truncate">${checkout}</span>`;
                }

                if (index === gameState.currentPlayerIndex) {
                    card.classList.add('active-player'); card.classList.remove('inactive-player');
                    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    card.classList.remove('active-player'); card.classList.add('inactive-player');
                }
            });
            updateTurnDisplay();
        }

        function updateTurnDisplay() {
            for (let i = 0; i < 3; i++) {
                const el = document.getElementById(`dart-${i+1}`);
                if (gameState.turnDarts[i]) {
                    el.innerText = gameState.turnDarts[i].text;
                    el.className = "w-10 h-10 rounded flex items-center justify-center text-sm font-digit shadow-lg border transition-all bg-slate-700 text-white border-green-500/50";
                } else {
                    el.innerText = '-';
                    el.className = "w-10 h-10 bg-gray-900/50 rounded border border-gray-700/50 flex items-center justify-center text-sm font-digit text-gray-600";
                }
            }
            const total = gameState.turnDarts.reduce((sum, d) => sum + d.value, 0);
            document.getElementById('turn-total').innerText = total;
            
            // Next button active state check
            const btns = [document.getElementById('btn-next-keypad'), document.getElementById('btn-next-board')];
            btns.forEach(btn => {
                if(gameState.turnDarts.length === 3) {
                    btn.classList.add('brightness-125', 'animate-pulse');
                } else {
                    btn.classList.remove('brightness-125', 'animate-pulse');
                }
            });
        }

        function toggleModifier(type) {
            if (type === 'double') gameState.multiplier = (gameState.multiplier === 2) ? 1 : 2;
            else if (type === 'triple') gameState.multiplier = (gameState.multiplier === 3) ? 1 : 3;
            updateModifierButtons();
        }
        function resetModifiers() { gameState.multiplier = 1; updateModifierButtons(); }
        
        function updateModifierButtons() {
            const btnD = document.getElementById('btn-double');
            const btnT = document.getElementById('btn-triple');
            btnD.classList.remove('active-red'); btnT.classList.remove('active');
            if (gameState.multiplier === 2) btnD.classList.add('active-red');
            if (gameState.multiplier === 3) btnT.classList.add('active');
        }

        function handleThrow(baseValue, specificMultiplier = null) {
            if (gameState.turnDarts.length >= 3) return;
            let effMult = specificMultiplier !== null ? specificMultiplier : gameState.multiplier;
            let finalValue = baseValue * effMult;
            let displayText = "";

            if (baseValue === 25) {
                if (specificMultiplier === null && gameState.multiplier === 3) { resetModifiers(); return; }
                if (effMult === 2) { finalValue = 50; displayText = "DB"; } else displayText = "25";
            } else if (baseValue === 0) {
                displayText = "MISS"; finalValue = 0;
            } else {
                if (effMult === 3) displayText = "T" + baseValue;
                else if (effMult === 2) displayText = "D" + baseValue;
                else displayText = baseValue.toString();
            }

            const currentThrow = { value: finalValue, text: displayText, multiplier: effMult, base: baseValue };
            gameState.turnDarts.push(currentThrow);

            const activePlayer = gameState.players[gameState.currentPlayerIndex];
            const currentScore = activePlayer.score;
            const newScore = currentScore - finalValue;

            let isBust = false;
            if (newScore < 0) isBust = true;
            else if (gameState.doubleOut && newScore === 1) isBust = true;

            if (isBust) {
                showToast("BUST!", "red");
                gameState.turnDarts[gameState.turnDarts.length-1].text = "BUST";
                gameState.turnDarts[gameState.turnDarts.length-1].isBustThrow = true;
                updateTurnDisplay();
                setTimeout(() => { confirmTurn(true); }, 800);
                resetModifiers();
                return;
            }

            activePlayer.score = newScore;
            if (newScore === 0) {
                if (gameState.doubleOut) {
                    const isDouble = currentThrow.multiplier === 2 || (currentThrow.base === 25 && currentThrow.multiplier === 2);
                    if (!isDouble) {
                        showToast("NEM DUPLA!", "orange");
                        activePlayer.score = currentScore;
                        gameState.turnDarts[gameState.turnDarts.length-1].text = "BUST";
                        updateTurnDisplay();
                        setTimeout(() => { confirmTurn(true); }, 1500);
                        resetModifiers();
                        return;
                    }
                }
                // Victory logic updates stats too
                let turnPoints = gameState.turnDarts.reduce((sum, d) => sum + d.value, 0);
                activePlayer.totalScore += turnPoints;
                activePlayer.totalDarts += gameState.turnDarts.length;
                updateUI();
                activePlayer.legs += 1;
                showWinner(activePlayer.name);
                return;
            }
            if (gameState.inputMode === 'keypad') resetModifiers();
            updateUI();
        }

        function undoThrow() {
            if (gameState.turnDarts.length === 0) return;
            const lastThrow = gameState.turnDarts.pop();
            gameState.players[gameState.currentPlayerIndex].score += lastThrow.value;
            updateUI();
        }

        function confirmTurn(isBust = false) {
            const activePlayer = gameState.players[gameState.currentPlayerIndex];
            let turnPoints = 0;
            if (isBust) {
                gameState.turnDarts.forEach(d => {
                    if (!d.isBustThrow && d.text !== "BUST") activePlayer.score += d.value;
                });
                turnPoints = 0;
            } else {
                turnPoints = gameState.turnDarts.reduce((sum, d) => sum + d.value, 0);
            }
            activePlayer.totalScore += turnPoints;
            activePlayer.totalDarts += gameState.turnDarts.length;
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            startNewTurn();
            updateUI();
        }

        function showWinner(name) {
            document.getElementById('winner-name').innerText = name + " nyert!";
            document.getElementById('winner-modal').classList.remove('hidden');
        }
        function closeWinnerModal() {
            document.getElementById('winner-modal').classList.add('hidden');
            restartGame();
        }
        function showToast(message, color = "red") {
            const toast = document.createElement('div');
            const bgClass = color === "orange" ? "bg-orange-500" : "bg-red-600";
            toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ${bgClass} text-white px-6 py-3 rounded-xl shadow-2xl z-[60] font-bold text-xl animate-bounce border border-white pointer-events-none`;
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1000);
        }

        initSetup();
    </script>
</body>
</html>
