<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darts Sz√°ml√°l√≥ Pro</title>
    <!-- Tailwind CSS bet√∂lt√©se -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Orbitron a sz√°mokhoz, Roboto a sz√∂veghez -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM --- */
        body {
            font-family: 'Roboto', sans-serif;
            background: radial-gradient(circle at top, #1e1b4b, #0f172a, #000000); /* M√©ly lila-k√©k-fekete gradiens */
            touch-action: manipulation;
        }
        
        /* Sci-fi bet≈±t√≠pus a sz√°moknak √©s c√≠meknek */
        h1, .score-display, .font-digit, .keypad-btn, .modifier-btn {
            font-family: 'Orbitron', sans-serif;
        }

        /* Glassmorphism panel (√ºveghat√°s) */
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Akt√≠v j√°t√©kos neon effekt */
        .active-player {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(15, 23, 42, 0.8));
            border: 1px solid #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.25), inset 0 0 10px rgba(34, 197, 94, 0.1);
            transform: scale(1.02);
            z-index: 10;
        }

        /* Inakt√≠v j√°t√©kos */
        .inactive-player {
            opacity: 0.6;
            transform: scale(0.98);
        }

        /* Gombok st√≠lusa */
        .keypad-btn {
            background: linear-gradient(to bottom, #334155, #1e293b);
            border-bottom: 3px solid #0f172a;
            border-top: 1px solid #475569;
            transition: all 0.1s;
        }
        .keypad-btn:active {
            transform: translateY(2px);
            border-bottom-width: 0;
            background: #1e293b;
        }

        /* M√≥dos√≠t√≥ gombok */
        .modifier-btn {
            background: linear-gradient(to bottom, #334155, #1e293b);
            border: 1px solid #475569;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .modifier-btn.active {
            background: linear-gradient(to bottom, #fbbf24, #d97706); /* Gold */
            color: black;
            border-color: #f59e0b;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
            text-shadow: none;
        }
        .modifier-btn.active-red {
            background: linear-gradient(to bottom, #f87171, #dc2626); /* Red */
            color: white;
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }

        /* Checkbox switch */
        .toggle-checkbox:checked { right: 0; border-color: #22c55e; }
        .toggle-checkbox:checked + .toggle-label { background-color: #22c55e; }
        
        .num-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }
        
        /* Anim√°ci√≥k */
        @keyframes neonPulse {
            0%, 100% { text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
            50% { text-shadow: 0 0 20px rgba(74, 222, 128, 0.8), 0 0 10px rgba(74, 222, 128, 0.5); }
        }
        .neon-text { animation: neonPulse 2s infinite; }

        /* --- DARTBOARD STYLES --- */
        #dartboard-svg {
            width: 100%;
            height: 100%;
            max-height: 300px; /* Limit height on larger screens */
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }
        .board-segment {
            cursor: pointer;
            stroke: #d4d4d4;
            stroke-width: 1px;
            transition: opacity 0.1s;
        }
        .board-segment:hover { opacity: 0.8; }
        .board-segment:active { filter: brightness(1.5); }
        
        .c-black { fill: #0f172a; } /* Dark slate */
        .c-white { fill: #cbd5e1; } /* Slate 300 */
        .c-red { fill: #ef4444; }   /* Red 500 */
        .c-green { fill: #22c55e; } /* Green 500 */
        
        .wire {
            fill: none;
            stroke: #94a3b8;
            stroke-width: 2;
            pointer-events: none;
        }
        
        .board-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            fill: #fff;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
            text-shadow: 0 0 3px #000;
        }
        
        /* Input Toggle Switch */
        .input-toggle-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            transition: all 0.3s;
        }
        .input-toggle-btn.active {
            background: #22c55e;
            color: white;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
            border-color: #22c55e;
        }

    </style>
</head>
<body class="text-white h-screen flex flex-col overflow-hidden">

    <!-- 1. BE√ÅLL√çT√ÅSOK K√âPERNY≈ê -->
    <div id="setup-screen" class="flex flex-col items-center justify-center h-full p-6 space-y-6 overflow-hidden relative">
        <!-- H√°tt√©r d√≠sz√≠t√©s -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 opacity-20 pointer-events-none">
            <div class="absolute top-10 left-10 w-64 h-64 bg-green-500 rounded-full blur-[100px]"></div>
            <div class="absolute bottom-10 right-10 w-80 h-80 bg-purple-600 rounded-full blur-[120px]"></div>
        </div>

        <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600 mb-2 flex-shrink-0 tracking-wider drop-shadow-lg">
            DARTS PRO
        </h1>
        
        <div class="w-full max-w-md glass-panel p-8 rounded-2xl shadow-2xl flex flex-col max-h-full overflow-hidden border border-white/10">
            
            <!-- J√°t√©kosok lista -->
            <div class="flex justify-between items-center mb-4">
                <label class="block text-gray-300 text-sm font-bold uppercase tracking-wider">J√°t√©kosok</label>
                <div class="flex gap-3">
                    <button onclick="shufflePlayers()" class="text-blue-400 hover:text-blue-300 text-sm font-bold flex items-center gap-1 cursor-pointer transition-colors px-2 py-1 rounded hover:bg-white/5">
                        <span class="text-lg">üîÄ</span> Kever√©s
                    </button>
                    <button onclick="addPlayerInput()" class="text-green-400 hover:text-green-300 text-sm font-bold flex items-center gap-1 cursor-pointer transition-colors px-2 py-1 rounded hover:bg-white/5">
                        <span class="text-lg">+</span> Hozz√°ad√°s
                    </button>
                </div>
            </div>
            
            <div id="setup-player-list" class="space-y-3 overflow-y-auto flex-1 mb-6 pr-2 min-h-[100px]">
                <!-- Dinamikus inputok -->
            </div>

            <!-- Be√°ll√≠t√°sok (Als√≥ fix r√©sz) -->
            <div class="space-y-5 pt-5 border-t border-gray-700/50 flex-shrink-0">
                <!-- J√°t√©km√≥d -->
                <div>
                    <label class="block text-gray-400 mb-1 text-xs font-bold uppercase">Kezd≈ë Pontsz√°m</label>
                    <select id="start-score-select" class="w-full p-3 bg-slate-800/80 rounded-lg border border-gray-600 outline-none text-xl font-bold text-white focus:border-green-500 transition-colors">
                        <option value="301">301</option>
                        <option value="501" selected>501</option>
                        <option value="701">701</option>
                    </select>
                </div>

                <!-- Szab√°lyok -->
                <div>
                    <label class="block text-gray-400 mb-3 text-xs font-bold uppercase">Szab√°lyok</label>
                    
                    <div class="flex items-center justify-between mb-3 bg-slate-800/40 p-2 rounded-lg">
                        <span class="text-gray-300 font-medium pl-2">Double In <span class="text-xs text-gray-500">(Dupla kezd√©s)</span></span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="double-in-check" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600 shadow-inner"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between bg-slate-800/40 p-2 rounded-lg">
                        <span class="text-gray-300 font-medium pl-2">Double Out <span class="text-xs text-gray-500">(Dupla kisz√°ll√≥)</span></span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="double-out-check" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600 shadow-inner"></div>
                        </label>
                    </div>
                </div>
                
                <button onclick="startGame()" class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-4 rounded-xl text-xl transition-all shadow-lg hover:shadow-green-500/30 transform hover:-translate-y-0.5 mt-2 cursor-pointer font-digit tracking-widest border border-green-400/20">
                    J√ÅT√âK IND√çT√ÅSA
                </button>
            </div>
        </div>
    </div>

    <!-- 2. J√ÅT√âK K√âPERNY≈ê -->
    <div id="game-screen" class="hidden flex-col h-full relative">
        <!-- H√°tt√©r elem -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 opacity-10 pointer-events-none">
             <div class="absolute top-1/4 right-0 w-96 h-96 bg-blue-600 rounded-full blur-[150px]"></div>
        </div>

        <!-- Fels≈ë s√°v -->
        <div class="px-4 py-2 flex justify-between items-center glass-panel z-50 relative border-b border-white/5">
            <button onclick="resetSetup()" class="text-gray-400 hover:text-white hover:bg-white/10 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 cursor-pointer transition">
                <span class="text-lg">‚ùÆ</span> Men√º
            </button>
            
            <div class="flex gap-3 text-xs font-mono font-bold">
                <span id="rule-indicator-in" class="hidden px-2 py-0.5 border border-green-500/50 text-green-400 bg-green-500/10 rounded shadow-[0_0_10px_rgba(34,197,94,0.2)]">DOUBLE IN</span>
                <span id="rule-indicator-out" class="hidden px-2 py-0.5 border border-red-500/50 text-red-400 bg-red-500/10 rounded shadow-[0_0_10px_rgba(239,68,68,0.2)]">DOUBLE OUT</span>
            </div>
            
            <button onclick="restartGame()" class="text-green-400 hover:text-green-300 hover:bg-green-500/10 px-3 py-1.5 rounded-lg text-sm font-bold cursor-pointer transition border border-transparent hover:border-green-500/30">
                √öjra ‚Ü∫
            </button>
        </div>

        <!-- Pontsz√°mok kijelz≈ëje (Grid) -->
        <div id="players-container" class="flex-1 grid grid-cols-2 gap-3 p-3 min-h-0 overflow-y-auto content-start z-0">
            <!-- JS t√∂lti fel -->
        </div>

        <!-- Aktu√°lis k√∂r kijelz≈ë -->
        <div class="bg-black/80 backdrop-blur-md py-3 px-4 border-t border-white/10 flex flex-col justify-center items-center h-24 flex-shrink-0 z-20 shadow-[0_-10px_30px_rgba(0,0,0,0.5)] relative">
            <div class="text-gray-500 text-[10px] uppercase tracking-[0.2em] mb-2 font-bold">Jelenlegi k√∂r</div>
            
            <div class="flex gap-4 w-full justify-center items-center">
                <div id="dart-1" class="w-16 h-12 bg-gray-900 rounded-lg border border-gray-700 flex items-center justify-center text-xl font-digit text-gray-500 shadow-inner"></div>
                <div id="dart-2" class="w-16 h-12 bg-gray-900 rounded-lg border border-gray-700 flex items-center justify-center text-xl font-digit text-gray-500 shadow-inner"></div>
                <div id="dart-3" class="w-16 h-12 bg-gray-900 rounded-lg border border-gray-700 flex items-center justify-center text-xl font-digit text-gray-500 shadow-inner"></div>
            </div>
            
            <div class="absolute right-4 bottom-3 text-right">
                 <div class="text-[10px] text-gray-500 uppercase tracking-wider">Total</div>
                 <div class="text-green-400 text-xl font-digit font-bold leading-none" id="turn-total">0</div>
            </div>
        </div>

        <!-- Vez√©rl≈ëpult -->
        <div class="glass-panel border-t-0 p-3 pb-6 flex-shrink-0 z-20 relative">
            
            <!-- Beviteli m√≥d v√°lt√≥ -->
            <div class="flex justify-center mb-4">
                <div class="bg-gray-800 p-1 rounded-full flex shadow-inner">
                    <button onclick="switchInputMode('keypad')" id="toggle-keypad" class="input-toggle-btn active rounded-full px-6 py-1.5 text-sm font-bold uppercase tracking-wider">Gombok</button>
                    <button onclick="switchInputMode('board')" id="toggle-board" class="input-toggle-btn rounded-full px-6 py-1.5 text-sm font-bold uppercase tracking-wider">T√°bla</button>
                </div>
            </div>

            <!-- KEYPAD MODE -->
            <div id="keypad-mode-container">
                <!-- Modifiers -->
                <div class="flex gap-3 mb-3 h-10">
                    <button onclick="toggleModifier('double')" id="btn-double" class="modifier-btn flex-1 rounded-lg text-red-400 font-bold text-lg hover:brightness-110 active:scale-95 transition-all">DOUBLE</button>
                    <button onclick="toggleModifier('triple')" id="btn-triple" class="modifier-btn flex-1 rounded-lg text-yellow-400 font-bold text-lg hover:brightness-110 active:scale-95 transition-all">TRIPLE</button>
                    <button onclick="undoThrow()" class="w-16 bg-slate-700 border border-slate-600 rounded-lg text-white text-xl flex items-center justify-center hover:bg-slate-600 active:scale-95 transition-all shadow-lg">‚å´</button>
                </div>

                <!-- 1-20 Sz√°mok -->
                <div class="num-grid h-48 mb-3">
                    <script>
                        for(let i=1; i<=20; i++) {
                            document.write(`<button onclick="handleThrow(${i})" class="keypad-btn rounded-md text-xl font-bold text-gray-200 shadow-lg">${i}</button>`);
                        }
                    </script>
                </div>
                 <!-- Speci√°lis gombok Keypad m√≥dban -->
                <div class="flex gap-3 h-14">
                    <button onclick="handleThrow(25)" class="flex-1 bg-gradient-to-b from-red-900 to-red-950 text-red-100 border border-red-800 rounded-xl font-bold text-lg hover:brightness-125 shadow-lg active:scale-95 transition-all font-digit tracking-wider">BULL</button>
                    <button onclick="handleThrow(0)" class="flex-1 bg-gradient-to-b from-slate-600 to-slate-800 text-gray-300 border border-slate-500 rounded-xl font-bold text-lg hover:brightness-110 shadow-lg active:scale-95 transition-all font-digit tracking-wider">MISS</button>
                </div>
            </div>

            <!-- BOARD MODE (Rejtett alapb√≥l) -->
            <div id="board-mode-container" class="hidden flex flex-col items-center">
                <div id="dartboard-wrapper" class="w-full flex justify-center items-center mb-4 relative">
                    <!-- SVG will be injected here -->
                </div>
                <!-- Controls for board mode -->
                 <div class="flex gap-3 h-14 w-full">
                    <button onclick="undoThrow()" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg text-white text-xl flex items-center justify-center hover:bg-slate-600 active:scale-95 transition-all shadow-lg">‚å´ UNDO</button>
                    <button onclick="handleThrow(0)" class="flex-1 bg-gradient-to-b from-slate-600 to-slate-800 text-gray-300 border border-slate-500 rounded-xl font-bold text-lg hover:brightness-110 shadow-lg active:scale-95 transition-all font-digit tracking-wider">MISS</button>
                </div>
            </div>

            <!-- Common NEXT button (Always visible at bottom) -->
            <div class="mt-3 h-16 w-full">
                <button onclick="confirmTurn()" id="btn-next" class="w-full h-full bg-gradient-to-b from-green-600 to-green-700 text-white rounded-xl font-bold text-2xl hover:from-green-500 hover:to-green-600 flex items-center justify-center shadow-lg border-b-4 border-green-900 active:border-b-0 active:translate-y-1 transition-all font-digit tracking-widest text-shadow-md">
                    NEXT PLAYER
                </button>
            </div>
            
        </div>
    </div>

    <!-- GY≈êZTES MODAL -->
    <div id="winner-modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-sm flex items-center justify-center z-[100] transition-opacity duration-300">
        <div class="relative bg-slate-900 p-10 rounded-3xl text-center max-w-sm w-full border-2 border-green-500/50 mx-4 shadow-[0_0_50px_rgba(34,197,94,0.3)] transform scale-100 overflow-hidden">
            <!-- Confetti effekt -->
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-green-500/10 to-transparent pointer-events-none"></div>

            <div class="text-7xl mb-6 animate-bounce drop-shadow-[0_0_15px_rgba(255,215,0,0.5)]">üèÜ</div>
            <h2 class="text-4xl font-bold text-white mb-2 font-digit tracking-widest">VICTORY</h2>
            <div class="h-1 w-24 bg-green-500 mx-auto mb-6 rounded-full shadow-[0_0_10px_#22c55e]"></div>
            
            <p id="winner-name" class="text-3xl text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-green-500 font-bold mb-8 font-digit">J√°t√©kos 1 nyert!</p>
            
            <button onclick="closeWinnerModal()" class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-all transform hover:-translate-y-1">
                √öj k√∂r ind√≠t√°sa
            </button>
        </div>
    </div>

    <script>
        // --- V√ÅLTOZ√ìK ---
        let gameState = {
            players: [],
            currentPlayerIndex: 0,
            startScore: 501,
            doubleIn: false,
            doubleOut: true,
            turnDarts: [], 
            multiplier: 1,
            inputMode: 'keypad' // 'keypad' or 'board'
        };

        const checkouts = {
            170: "T20 T20 BULL", 167: "T20 T19 BULL", 164: "T20 T18 BULL", 161: "T20 T17 BULL", 160: "T20 T20 D20",
            158: "T20 T20 D19", 157: "T20 T19 D20", 156: "T20 T20 D18", 155: "T20 T19 D19", 154: "T20 T18 D20",
            153: "T20 T19 D18", 152: "T20 T20 D16", 151: "T20 T17 D20", 150: "T20 T18 D18", 149: "T20 T19 D16",
            148: "T20 T16 D20", 147: "T20 T17 D18", 146: "T20 T18 D16", 145: "T20 T15 D20", 144: "T20 T20 D12",
            143: "T20 T17 D16", 142: "T20 T14 D20", 141: "T20 T19 D12", 140: "T20 T16 D16", 139: "T20 T13 D20",
            138: "T20 T18 D12", 137: "T19 T16 D16", 136: "T20 T20 D8", 135: "T20 T15 D15", 134: "T20 T14 D16",
            133: "T20 T19 D8", 132: "T20 T16 D12", 131: "T20 T13 D16", 130: "T20 T18 D8", 129: "T19 T16 D12",
            128: "T18 T14 D16", 127: "T20 T17 D8", 126: "T19 T19 D6", 125: "BULL T17 D12", 124: "T20 T16 D8",
            123: "T19 T16 D9", 122: "T18 T20 D4", 121: "T20 T15 D8", 120: "T20 20 D20", 119: "T19 T10 D16",
            118: "T20 18 D20", 117: "T20 17 D20", 116: "T20 16 D20", 115: "T20 15 D20", 114: "T20 14 D20",
            113: "T20 13 D20", 112: "T20 12 D20", 111: "T20 19 D16", 110: "T20 18 D16", 109: "T20 17 D16",
            108: "T20 16 D16", 107: "T19 18 D16", 106: "T20 14 D16", 105: "T20 13 D16", 104: "T18 18 D16",
            103: "T20 3 D20", 102: "T20 10 D16", 101: "T17 10 D20", 100: "T20 D20", 99: "T19 10 D16",
            98: "T20 D19", 97: "T19 D20", 96: "T20 D18", 95: "T19 D19", 94: "T18 D20",
            93: "T19 D18", 92: "T20 D16", 91: "T17 D20", 90: "T18 D18", 89: "T19 D16",
            88: "T16 D20", 87: "T17 D18", 86: "T18 D16", 85: "T15 D20", 84: "T20 D12",
            83: "T17 D16", 82: "BULL D16", 81: "T19 D12", 80: "T20 D10", 79: "T13 D20",
            78: "T18 D12", 77: "T19 D10", 76: "T20 D8", 75: "T17 D12", 74: "T14 D16",
            73: "T19 D8", 72: "T16 D12", 71: "T13 D16", 70: "T18 D8", 69: "T19 D6",
            68: "T20 D4", 67: "T17 D8", 66: "T10 D18", 65: "T19 D4", 64: "T16 D8",
            63: "T13 D12", 62: "T10 D16", 61: "T15 D8", 60: "20 D20", 59: "19 D20",
            58: "18 D20", 57: "17 D20", 56: "16 D20", 55: "15 D20", 54: "14 D20",
            53: "13 D20", 52: "12 D20", 51: "19 D16", 50: "18 D16", 49: "17 D16",
            48: "16 D16", 47: "15 D16", 46: "14 D16", 45: "13 D16", 44: "12 D16",
            43: "11 D16", 42: "10 D16", 41: "9 D16", 40: "D20", 39: "7 D16",
            38: "D19", 37: "5 D16", 36: "D18", 35: "3 D16", 34: "D17",
            33: "1 D16", 32: "D16", 31: "15 D8", 30: "D15", 29: "13 D8",
            28: "D14", 27: "11 D8", 26: "D13", 25: "9 D8", 24: "D12",
            23: "7 D8", 22: "D11", 21: "5 D8", 20: "D10", 19: "3 D8",
            18: "D9", 17: "1 D8", 16: "D8", 15: "7 D4", 14: "D7",
            13: "5 D4", 12: "D6", 11: "3 D4", 10: "D5", 9: "1 D4",
            8: "D4", 7: "3 D2", 6: "D3", 5: "1 D2", 4: "D2",
            3: "1 D1", 2: "D1"
        };

        function getCheckout(score) {
            if (score > 170 || score < 2) return null;
            return checkouts[score] || null;
        }

        // --- SETUP SCREEN ---
        let setupPlayerCount = 0;

        function initSetup() {
            const container = document.getElementById('setup-player-list');
            container.innerHTML = '';
            setupPlayerCount = 0;
            addPlayerInput("J√°t√©kos 1");
            addPlayerInput("J√°t√©kos 2");
        }

        function addPlayerInput(defaultName = "") {
            setupPlayerCount++;
            const name = defaultName || `J√°t√©kos ${setupPlayerCount}`;
            const container = document.getElementById('setup-player-list');
            
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center animate-fade-in";
            div.innerHTML = `
                <input type="text" class="player-name-input flex-1 p-3 bg-slate-800/80 rounded-lg border border-gray-600 focus:border-green-500 focus:bg-slate-800 outline-none text-lg text-white transition-colors" value="${name}" placeholder="J√°t√©kos neve">
                ${setupPlayerCount > 2 ? `<button onclick="removePlayerInput(this)" class="w-10 h-full text-red-400 hover:text-red-300 font-bold text-xl p-2 cursor-pointer transition transform hover:scale-110">√ó</button>` : ''}
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removePlayerInput(btn) {
            btn.parentElement.remove();
            setupPlayerCount--;
        }

        function shufflePlayers() {
            const container = document.getElementById('setup-player-list');
            const inputs = Array.from(container.querySelectorAll('.player-name-input'));
            const values = inputs.map(input => input.value);
            
            for (let i = values.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [values[i], values[j]] = [values[j], values[i]];
            }
            
            inputs.forEach((input, index) => {
                input.value = values[index];
                const row = input.parentElement;
                row.classList.add('brightness-150');
                setTimeout(() => row.classList.remove('brightness-150'), 300);
            });
        }

        // --- DARTBOARD GENERATION LOGIC ---
        function generateDartboard() {
            const wrapper = document.getElementById('dartboard-wrapper');
            const order = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
            const svgNS = "http://www.w3.org/2000/svg";
            
            // Create SVG element
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("id", "dartboard-svg");
            svg.setAttribute("viewBox", "-210 -210 420 420");
            
            // Radii definition (in svg units)
            const r_bull = 12;
            const r_outer_bull = 30;
            const r_inner_single = 95;
            const r_triple = 105;
            const r_outer_single = 160;
            const r_double = 170;
            
            // Helper to create circle
            function createCircle(r, cls, onClick) {
                const c = document.createElementNS(svgNS, "circle");
                c.setAttribute("r", r);
                c.setAttribute("class", cls + " board-segment");
                if (onClick) c.onclick = onClick;
                return c;
            }

            // Helper to generate arc path
            function createSlicePath(startAngle, endAngle, innerR, outerR, cls, val, mult) {
                // Convert degrees to radians, subtract 90 to start from top
                const start = (startAngle - 90) * Math.PI / 180;
                const end = (endAngle - 90) * Math.PI / 180;

                const x1 = outerR * Math.cos(start);
                const y1 = outerR * Math.sin(start);
                const x2 = outerR * Math.cos(end);
                const y2 = outerR * Math.sin(end);
                
                const x3 = innerR * Math.cos(end);
                const y3 = innerR * Math.sin(end);
                const x4 = innerR * Math.cos(start);
                const y4 = innerR * Math.sin(start);

                // Path command
                // M move to start outer
                // A arc to end outer
                // L line to end inner
                // A arc to start inner
                // Z close
                const pathData = `M ${x1} ${y1} A ${outerR} ${outerR} 0 0 1 ${x2} ${y2} L ${x3} ${y3} A ${innerR} ${innerR} 0 0 0 ${x4} ${y4} Z`;

                const path = document.createElementNS(svgNS, "path");
                path.setAttribute("d", pathData);
                path.setAttribute("class", cls + " board-segment");
                path.onclick = () => handleThrow(val, mult);
                return path;
            }
            
            // Helper for Text
            function createText(angle, dist, text) {
                const rad = (angle - 90) * Math.PI / 180;
                const x = dist * Math.cos(rad);
                const y = dist * Math.sin(rad);
                const t = document.createElementNS(svgNS, "text");
                t.setAttribute("x", x);
                t.setAttribute("y", y + 5); // small visual correction
                t.setAttribute("class", "board-text");
                t.textContent = text;
                return t;
            }

            // Group for slices
            const gSlices = document.createElementNS(svgNS, "g");
            
            // Draw Slices (20 segments)
            const angleStep = 360 / 20;
            // The 20 slice is centered at top, so it goes from -9 to +9 degrees.
            // Loop goes through order array. index 0 (value 20) corresponds to 0 deg center.
            
            order.forEach((val, i) => {
                const centerAngle = i * angleStep;
                const startAngle = centerAngle - angleStep/2;
                const endAngle = centerAngle + angleStep/2;
                
                const isEven = i % 2 === 0; // Alternating colors
                const cSingle = isEven ? "c-black" : "c-white";
                const cSpecial = isEven ? "c-red" : "c-green";
                
                // Double Ring
                gSlices.appendChild(createSlicePath(startAngle, endAngle, r_outer_single, r_double, cSpecial, val, 2));
                // Outer Single
                gSlices.appendChild(createSlicePath(startAngle, endAngle, r_triple, r_outer_single, cSingle, val, 1));
                // Triple Ring
                gSlices.appendChild(createSlicePath(startAngle, endAngle, r_inner_single, r_triple, cSpecial, val, 3));
                // Inner Single
                gSlices.appendChild(createSlicePath(startAngle, endAngle, r_outer_bull, r_inner_single, cSingle, val, 1));
                
                // Text labels
                svg.appendChild(createText(centerAngle, r_double + 25, val.toString()));
            });
            
            svg.appendChild(gSlices);

            // Bulls
            svg.appendChild(createCircle(r_outer_bull, "c-green", () => handleThrow(25, 1)));
            svg.appendChild(createCircle(r_bull, "c-red", () => handleThrow(25, 2))); // Bullseye is Double Bull (50)
            
            wrapper.appendChild(svg);
        }

        // --- GAME LOGIC ---

        function startGame() {
            const inputs = document.querySelectorAll('.player-name-input');
            const newPlayers = [];
            
            inputs.forEach((input, index) => {
                const name = input.value.trim() || `J√°t√©kos ${index + 1}`;
                newPlayers.push({
                    id: index,
                    name: name,
                    score: parseInt(document.getElementById('start-score-select').value),
                    legs: 0,
                    totalScore: 0,
                    totalDarts: 0
                });
            });

            if (newPlayers.length < 1) return;

            gameState.players = newPlayers;
            gameState.startScore = gameState.players[0].score;
            gameState.currentPlayerIndex = 0;
            gameState.doubleIn = document.getElementById('double-in-check').checked;
            gameState.doubleOut = document.getElementById('double-out-check').checked;
            gameState.inputMode = 'keypad'; // Default reset
            
            // UI Indicators
            const diBadge = document.getElementById('rule-indicator-in');
            const doBadge = document.getElementById('rule-indicator-out');
            
            gameState.doubleIn ? diBadge.classList.remove('hidden') : diBadge.classList.add('hidden');
            gameState.doubleOut ? doBadge.classList.remove('hidden') : doBadge.classList.add('hidden');

            startNewTurn();
            renderGamePlayers();
            updateUI();
            
            // Check if board generated
            if(!document.getElementById('dartboard-svg')) {
                generateDartboard();
            }
            switchInputMode('keypad'); // Reset view

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('flex');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
        }

        function renderGamePlayers() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            container.className = 'flex-1 grid gap-3 p-3 min-h-0 overflow-y-auto content-start z-0';
            
            if (gameState.players.length === 2) {
                container.classList.add('grid-cols-2');
            } else {
                container.classList.add('grid-cols-2');
            }

            gameState.players.forEach((player, index) => {
                const card = document.createElement('div');
                card.id = `player-card-${index}`;
                // √öj k√°rtya diz√°jn
                card.className = `glass-panel rounded-xl p-3 flex flex-col items-center justify-center relative transition-all duration-300 min-h-[150px] inactive-player`;
                
                card.innerHTML = `
                    <div class="text-gray-300 text-sm font-bold uppercase tracking-wider mb-2 truncate w-full text-center px-1 font-digit">${player.name}</div>
                    <div class="text-5xl sm:text-6xl font-bold text-white tracking-tighter score-display mb-1 neon-text">${player.score}</div>
                    
                    <div id="checkout-container-${index}" class="min-h-[28px] w-full text-center mb-2"></div>

                    <div class="mt-auto w-full flex justify-between items-center text-xs text-gray-400 bg-slate-900/50 px-3 py-1.5 rounded-lg border border-white/5">
                        <span class="font-bold">Legs: <span id="legs-${index}" class="text-white text-sm">0</span></span>
                        <span class="font-bold">Avg: <span id="avg-${index}" class="text-white text-sm">0.00</span></span>
                    </div>
                    
                    <!-- Akt√≠v jelz≈ë -->
                    <div id="indicator-${index}" class="hidden absolute top-3 right-3 w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>
                `;
                container.appendChild(card);
            });
        }

        function restartGame() {
            gameState.players.forEach(p => p.score = gameState.startScore);
            gameState.currentPlayerIndex = 0;
            startNewTurn();
            updateUI();
        }

        function startNewTurn() {
            gameState.turnDarts = [];
            gameState.multiplier = 1;
            resetModifiers();
            updateTurnDisplay();
        }

        function resetSetup() {
            if(confirm("Biztosan ki akarsz l√©pni a f≈ëmen√ºbe?")) {
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('flex');
                document.getElementById('setup-screen').classList.remove('hidden');
                document.getElementById('setup-screen').classList.add('flex');
            }
        }
        
        // --- INPUT MODE SWITCHING ---
        function switchInputMode(mode) {
            gameState.inputMode = mode;
            const keypadBtn = document.getElementById('toggle-keypad');
            const boardBtn = document.getElementById('toggle-board');
            const keypadContainer = document.getElementById('keypad-mode-container');
            const boardContainer = document.getElementById('board-mode-container');
            
            if (mode === 'keypad') {
                keypadBtn.classList.add('active');
                boardBtn.classList.remove('active');
                keypadContainer.classList.remove('hidden');
                boardContainer.classList.add('hidden');
            } else {
                keypadBtn.classList.remove('active');
                boardBtn.classList.add('active');
                keypadContainer.classList.add('hidden');
                boardContainer.classList.remove('hidden');
                // Ensure multiplier is reset when switching to board
                resetModifiers();
            }
        }

        function updateUI() {
            gameState.players.forEach((player, index) => {
                const card = document.getElementById(`player-card-${index}`);
                const indicator = document.getElementById(`indicator-${index}`);
                const scoreDiv = card.querySelector('.score-display');
                const legsSpan = document.getElementById(`legs-${index}`);
                const avgSpan = document.getElementById(`avg-${index}`);
                const checkoutContainer = document.getElementById(`checkout-container-${index}`);

                scoreDiv.innerText = player.score;
                legsSpan.innerText = player.legs;
                
                const avg = player.totalDarts > 0 ? ((player.totalScore / player.totalDarts) * 3).toFixed(2) : "0.00";
                avgSpan.innerText = avg;

                checkoutContainer.innerHTML = '';
                if (index === gameState.currentPlayerIndex && gameState.doubleOut) {
                    const checkout = getCheckout(player.score);
                    if (checkout) {
                        checkoutContainer.innerHTML = `<span class="text-yellow-400 text-sm font-bold bg-yellow-400/10 px-3 py-1 rounded-full border border-yellow-400/30 shadow-sm animate-pulse block truncate tracking-wide">${checkout}</span>`;
                    }
                }

                if (index === gameState.currentPlayerIndex) {
                    card.classList.add('active-player');
                    card.classList.remove('inactive-player');
                    indicator.classList.remove('hidden');
                    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    card.classList.remove('active-player');
                    card.classList.add('inactive-player');
                    indicator.classList.add('hidden');
                }
            });

            updateTurnDisplay();
        }

        function updateTurnDisplay() {
            for (let i = 0; i < 3; i++) {
                const el = document.getElementById(`dart-${i+1}`);
                if (gameState.turnDarts[i]) {
                    el.innerText = gameState.turnDarts[i].text;
                    el.className = "w-16 h-12 rounded-lg flex items-center justify-center text-xl font-digit shadow-lg border transition-all duration-200";
                    // Akt√≠v dob√°s sz√≠ne
                    el.classList.add('bg-gradient-to-br', 'from-slate-700', 'to-slate-800', 'text-white', 'border-green-500/50', 'shadow-green-500/10');
                } else {
                    el.innerText = '-';
                    el.className = "w-16 h-12 bg-gray-900/50 rounded-lg border border-gray-700/50 flex items-center justify-center text-xl font-digit text-gray-600 shadow-inner";
                }
            }

            const total = gameState.turnDarts.reduce((sum, d) => sum + d.value, 0);
            document.getElementById('turn-total').innerText = total;

            const nextBtn = document.getElementById('btn-next');
            if (gameState.turnDarts.length === 3) {
                nextBtn.classList.remove('opacity-80');
                nextBtn.classList.add('brightness-110');
            } else {
                 // reset style if needed
            }
        }

        function toggleModifier(type) {
            if (type === 'double') {
                gameState.multiplier = (gameState.multiplier === 2) ? 1 : 2;
            } else if (type === 'triple') {
                gameState.multiplier = (gameState.multiplier === 3) ? 1 : 3;
            }
            updateModifierButtons();
        }

        function resetModifiers() {
            gameState.multiplier = 1;
            updateModifierButtons();
        }

        function updateModifierButtons() {
            const btnD = document.getElementById('btn-double');
            const btnT = document.getElementById('btn-triple');

            btnD.classList.remove('active-red');
            btnT.classList.remove('active');

            if (gameState.multiplier === 2) btnD.classList.add('active-red');
            if (gameState.multiplier === 3) btnT.classList.add('active');
        }

        function handleThrow(baseValue, specificMultiplier = null) {
            if (gameState.turnDarts.length >= 3) return;

            // If a specific multiplier comes from the board (e.g. clicking triple ring), use it.
            // Otherwise use the keypad modifier state.
            let effectiveMultiplier = specificMultiplier !== null ? specificMultiplier : gameState.multiplier;
            
            let finalValue = baseValue * effectiveMultiplier;
            let displayText = "";

            if (baseValue === 25) {
                // Keypad logic for Bull
                if (specificMultiplier === null && gameState.multiplier === 3) { resetModifiers(); return; } 
                
                if (effectiveMultiplier === 2) {
                    finalValue = 50; 
                    displayText = "DB"; 
                } else {
                    displayText = "25";
                }
            } else if (baseValue === 0) {
                displayText = "MISS";
                finalValue = 0;
            } else {
                if (effectiveMultiplier === 3) displayText = "T" + baseValue;
                else if (effectiveMultiplier === 2) displayText = "D" + baseValue;
                else displayText = baseValue.toString();
            }

            const currentThrow = {
                value: finalValue,
                text: displayText,
                multiplier: effectiveMultiplier,
                base: baseValue
            };

            gameState.turnDarts.push(currentThrow);

            const activePlayer = gameState.players[gameState.currentPlayerIndex];
            const currentScore = activePlayer.score;
            const newScore = currentScore - finalValue;

            let isBust = false;
            if (newScore < 0) isBust = true;
            else if (gameState.doubleOut && newScore === 1) isBust = true;
            
            if (isBust) {
                showToast("BUST!", "red");
                gameState.turnDarts[gameState.turnDarts.length-1].text = "BUST";
                gameState.turnDarts[gameState.turnDarts.length-1].isBustThrow = true; 
                updateTurnDisplay();
                setTimeout(() => { confirmTurn(true); }, 1000);
                resetModifiers();
                return;
            }

            activePlayer.score = newScore;
            
            if (newScore === 0) {
                if (gameState.doubleOut) {
                    // Check logic depending on where multiplier came from
                    const isDouble = currentThrow.multiplier === 2 || (currentThrow.base === 25 && currentThrow.multiplier === 2);
                    if (!isDouble) {
                        showToast("INVALID CHECKOUT!", "orange");
                        activePlayer.score = currentScore;
                        gameState.turnDarts[gameState.turnDarts.length-1].text = "BUST";
                        updateTurnDisplay();
                        setTimeout(() => { confirmTurn(true); }, 1500);
                        resetModifiers();
                        return;
                    }
                }
                
                let turnPoints = gameState.turnDarts.reduce((sum, d) => sum + d.value, 0);
                let turnCount = gameState.turnDarts.length;
                
                activePlayer.totalScore += turnPoints;
                activePlayer.totalDarts += turnCount;

                updateUI();
                activePlayer.legs += 1;
                showWinner(activePlayer.name);
                return;
            }

            // Only reset keypad modifiers if we are in keypad mode
            if (gameState.inputMode === 'keypad') {
                resetModifiers();
            }
            updateUI();
        }

        function undoThrow() {
            if (gameState.turnDarts.length === 0) return;
            const lastThrow = gameState.turnDarts.pop();
            gameState.players[gameState.currentPlayerIndex].score += lastThrow.value;
            updateUI();
        }

        function confirmTurn(isBust = false) {
            const activePlayer = gameState.players[gameState.currentPlayerIndex];
            
            let turnPoints = 0;
            let turnCount = gameState.turnDarts.length; 

            if (isBust) {
                gameState.turnDarts.forEach(d => {
                    if (!d.isBustThrow && d.text !== "BUST") {
                        activePlayer.score += d.value;
                    }
                });
                turnPoints = 0;
            } else {
                turnPoints = gameState.turnDarts.reduce((sum, d) => sum + d.value, 0);
            }

            activePlayer.totalScore += turnPoints;
            activePlayer.totalDarts += turnCount;

            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            
            startNewTurn();
            updateUI();
        }

        function showWinner(name) {
            document.getElementById('winner-name').innerText = name + " nyert!";
            document.getElementById('winner-modal').classList.remove('hidden');
        }

        function closeWinnerModal() {
            document.getElementById('winner-modal').classList.add('hidden');
            restartGame();
        }
        
        function showToast(message, color = "red") {
            const toast = document.createElement('div');
            const bgClass = color === "orange" ? "bg-orange-500" : "bg-red-600";
            toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ${bgClass} text-white px-8 py-4 rounded-xl shadow-[0_0_30px_rgba(239,68,68,0.5)] z-[60] font-bold text-2xl animate-bounce border-2 border-white pointer-events-none font-digit tracking-widest`;
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 1000);
        }

        initSetup();

    </script>
</body>
</html>
